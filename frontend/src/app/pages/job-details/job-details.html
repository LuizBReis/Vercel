<div class="details-container">
  <a routerLink="/dashboard" mat-stroked-button>&#8592; Voltar para todas as vagas</a>

  @if (isLoading) {
    <mat-spinner></mat-spinner>
  }

  @if (!isLoading && job) {
    <mat-card class="job-details-card">
      <mat-card-header>
        <mat-card-title class="job-title-container">
          <span>{{ job.title }}</span>
          
          @if (isAuthor) {
            <div>
              <button mat-icon-button (click)="openEditJobDialog()">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="onDeleteJob()">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          }
        </mat-card-title>
        <mat-card-subtitle>Publicado por <a [routerLink]="['/profile', job.author.user.id]">{{ job.author.companyName || (job.author.user.firstName + ' ' + job.author.user.lastName) }}</a>
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <h3>Descrição</h3>
        <p class="description">{{ job.description }}</p>
        @if (job.budget) {
          <h3>Orçamento</h3>
          <p class="budget">{{ job.budget | currency:'BRL' }}</p>
        }
      </mat-card-content>
      
      <mat-card-actions>
        @if (userRole === 'FREELANCER' && !job.hasApplied) {
          <button mat-raised-button 
                  color="primary" 
                  (click)="onApply()">
            <mat-icon>send</mat-icon>
            Candidatar-se Agora
          </button>
        }

        @if (userRole === 'FREELANCER' && job.hasApplied) {
          <button mat-flat-button color="accent" disabled>
            <mat-icon>check_circle</mat-icon>
            Candidatura Enviada
          </button>
        }
        
      </mat-card-actions>
    </mat-card>

    @if (isAuthor) {
      <mat-card class="applicants-card">
        <mat-card-header>
          <mat-card-title>Candidatos para esta Vaga</mat-card-title>
        </mat-card-header>
        <mat-card-content>
    
          <mat-form-field appearance="outline" class="filter-input">
            <mat-label>Filtrar por skill</mat-label>
            <input matInput [formControl]="applicantFilterControl" placeholder="Ex: Pet Sitter">
          </mat-form-field>
    
          @if (applicants$ | async; as applicants) {
            <p><strong>Total: {{ applicants.length }}</strong></p>
            @if (applicants.length > 0) {
              <mat-list role="list">
              @for (app of applicants; track app.applicant.id) {
                <mat-list-item role="listitem" class="applicant-item">
                  
                  <div class="applicant-item-content">
                    
                    <a [routerLink]="['/profile', app.applicant.id]" class="applicant-link">
                      {{ app.applicant.firstName }} {{ app.applicant.lastName }}
                    </a>

                    <div class="applicant-actions">
                      <button mat-icon-button (click)="onStartConversation(app.id)" matTooltip="Iniciar conversa">
                        <mat-icon>chat</mat-icon>
                      </button>
                      @if (app.status === 'PENDING') {
                        <button mat-icon-button color="primary" (click)="updateApplicationStatus(app.id, 'SHORTLISTED')" matTooltip="Selecionar candidato">
                          <mat-icon>thumb_up</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" (click)="updateApplicationStatus(app.id, 'REJECTED')" matTooltip="Rejeitar candidato">
                          <mat-icon>thumb_down</mat-icon>
                        </button>
                      } @else {
                        <span class="status-chip" [ngClass]="app.status.toLowerCase()">{{ app.status | titlecase }}</span>
                      }
                    </div>

                  </div> </mat-list-item>
              }
              </mat-list>
            } @else {
              <p>Nenhum candidato encontrado com este filtro.</p>
            }
          }
        </mat-card-content>
      </mat-card>
    }
  }

  @if (!isLoading && !job) {
    <div>
      <h2>Vaga não encontrada</h2>
      <p>A vaga que você está procurando não existe ou pode ter sido removida.</p>
    </div>
  }
</div>